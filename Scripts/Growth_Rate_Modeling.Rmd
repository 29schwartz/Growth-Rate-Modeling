---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
#You have to run this entire code chunk everytime!
getwd() -> working_directory
setwd(working_directory) 

# Packages To Install -----------------------------------------------------
source("../Functions/Load_Packages.R")


# thematic elements -----------------------------------------------------
source("../Functions/SKS_Personal_Theme.R")
```

## Loading Data

```{r}

#using the flopr package to wrangle TECAN Spark data. See flopr on github for more info!
#' @param data_csv needs to be the raw TECAN data in CSV form!
#' @param layout_csv needs to be filled in according to the example layout.
#'    you can add as many columns as you want BUT THE LAST COLUMN MUST BE named 'well' and have the position for each well such as 'A1'
#'    
#'    Added the appropriate columns to the metadata file and load them here! It must be a .csv file type!

#load install

plate1 <- drop_na(flopr::spark_parse(data_csv = "../Data/Example_Data.csv",
                                     layout_csv = "../Data/Metadata.csv",
                                     timeseries = TRUE))

#Change time if necessary! I am changing from seconds to hours! 
plate1 %<>%
  mutate(across(time, ~.x / 3600)) %>%
  modify_if(is.character, as.factor) %>% 
  #This is critical so that R treats the replciates as a grouping and not as a number!
  modify_at(c("Replicate"), as.factor)

#Below are some other functions you may want to use just use the %>% operator as shown above if you want to change more things!
  #mutate(across(Plasmid, str_replace, 'pLW003', 'ev')) %>%
  #mutate(across(Plasmid, str_replace, 'pLW002', '+SIR')) %>%
  #mutate(Variant = Plasmid)
  
```

### Quick visualization of data

```{r fig.width= 6, fig.height= 6}
readydata %>%
  #For better visualization you may want to filter out timepoints
  #filter(time <= 15) %>%
  ggplot(aes(x = time, y = OD600, color = Media)) + 
  geom_point() +
  #This allows you to split a single plot with many lines into individual plots based on a feature 
  facet_wrap(~Plasmid)+
  Theme
```

## Nesting Data

```{r}
#' @concept This is creating a nested data frame. The main difference between a nested data frame and grouped data frame is that for a grouped data frame, each row is an observation. For a nested data frame each row is a group of observations!

#This will allow us to easily apply function/models across all the data available. 
#Using Tidymodels we can then easily organize the coefficients for our different models!

#the across function allows for selecting specific columns! I want the default time column and I want any column that has the word OD in it in case someone uses multiple ODs for flourescent proteins! 

#THIS WILL ONLY WORK IF YOUR OPTICAL DENSITY CHANNELS HAVE THE WORD OD IN THEM!

 plate1 %<>%
  select(-c(well, row, column)) %>%
  group_by(across(-c(time, contains("OD")))) %>%
  nest()
  
```

```{r}
source("../Functions/Gompertz_nls.R")

#Therefore, You have to decide when to filter the data so that it looks like a logistic curve! Use your positive control in complete media (if using M9C and M9sa) as a reference

by_variant %>%
  #Can't have NAs in any of the columns!
  nplyr::nest_drop_na(data) %>%
  #You will have to adjust these parameters a bit to get fits, especially if you cells grew poorly! These are good starting estimates. 
  mutate(model = pmap(list(data, A_par = 1.00, mu_par = .5, lambda_par = 5), gompertz_model)) %>%
  #Create summary of coefficients
  mutate(summary = map(model, tidy)) %>%
  #Get residuals for model that can be plotted on top in a ggplot object
  mutate(augment = map(model, augment)) %>%
  #Using Glance to get an idea of model fit 
  mutate(model.fit = map(model, glance)) -> growth_variants
```

```{r, fig.height= 6, fig.width= 10}

#Use this graph to look at the fits quickly to see if they look ok!
growth_variants %>%
  unnest(augment) %>%
  ggplot(aes(x = time, y = OD600)) + 
  geom_point(size = 1.5) + 
  geom_line(aes(y = .fitted), color = "blue", size = 1.25) +
  labs(y = 'Absorbance ('~OD[600]~')', x = "Timepoint (Hr)", title = "4-HT Positive Controls") +
  scale_x_continuous(limits=c(0, 17)) + 
  scale_y_continuous(limits=c(0, 1.8)) +
  facet_wrap(Plate ~ Replicate) +
Theme

```

```{r}
#this code chunk will create a new column that lists the predictions for the estimates as well as their standard deviations and P-values. 

growth_variants%<>%
  unnest(summary) %>%
  pivot_wider(names_from = term, values_from = c(estimate, std.error, statistic,p.value))

```

#Plotting Fitted Estimates

```{r, warnings = FALSE}
#This function will plot the estimate mu as a boxplot (you may want to use a scatter plot depending on the number of replicates)
fitted_variants %>%
  ggplot(aes(x = Plasmid, y = estimate_mu, fill = RBS)) + 
  geom_boxplot() +
  facet_wrap(~Media) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
#This code chunk will calculate the change in growth rate of the cells in incomplete media relative to the complete media. 
fitted_variants %>%
  group_by(Plasmid, Replicate) %>%
  mutate(lesser_val = lead(estimate_mu)) %>%
  drop_na() %>%
  mutate(percent_change = lesser_val / estimate_mu) -> mu_percent
```


```{r}
mu_percent %>%
  ggplot(aes(x = Plasmid, y = percent_change)) + 
  geom_boxplot(aes(fill = RBS )) +
  facet_wrap(~Promoter, scales = "free_x") +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = "", y = "M9sa Growth Rate Relative to M9C") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
