---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
#You have to run this entire code chunk everytime!
getwd() -> working_directory
setwd(working_directory) 

# Packages To Install -----------------------------------------------------
source("../Functions/Load_Packages.R")


# thematic elements -----------------------------------------------------
source("../Functions/SKS_Personal_Theme.R")
```

## Loading Data

```{r}

#using the flopr package to wrangle TECAN Spark data. See flopr on github for more info!
#' @param data_csv needs to be the raw TECAN data in CSV form!
#' @param layout_csv needs to be filled in according to the example layout.
#'    you can add as many columns as you want BUT THE LAST COLUMN MUST BE named 'well' and have the position for each well such as 'A1'
#'    
#'    Added the appropriate columns to the metadata file and load them here! It must be a .csv file type!

#load install

plate1 <- drop_na(flopr::spark_parse(data_csv = "../Data/Example_Data.csv",
                                     layout_csv = "../Data/Metadata.csv",
                                     timeseries = TRUE))

#Change time if necessary! I am changing from seconds to hours! 
plate1 %<>%
  mutate(across(time, ~.x / 3600)) %>%
  modify_if(is.character, as.factor) %>% 
  #This is critical so that R treats the replciates as a grouping and not as a number!
  modify_at(c("Replicate"), as.factor)

#Below are some other functions you may want to use just use the %>% operator as shown above if you want to change more things!
  #mutate(across(Plasmid, str_replace, 'pLW003', 'ev')) %>%
  #mutate(across(Plasmid, str_replace, 'pLW002', '+SIR')) %>%
  #mutate(Variant = Plasmid)
  
```

### Quick visualization of data

```{r fig.width= 6, fig.height= 6}
readydata %>%
  #For better visualization you may want to filter out timepoints
  #filter(time <= 15) %>%
  ggplot(aes(x = time, y = OD600, color = Media)) + 
  geom_point() +
  #This allows you to split a single plot with many lines into individual plots based on a feature 
  facet_wrap(~Plasmid)+
  Theme
```

## Nesting Data

```{r}
#For model fitting to work you need to exclude the death phase. The model cannot account for the drop in optical density following stationary.

#Therefore, You have to decide when to filter the data so that it looks like a logistic curve! Use your positive control in complete media (if using M9C and M9sa) as a reference

plate1 %<>%
  filter(time < put_time_here)
```

```{r}
#' @concept This is creating a nested data frame. The main difference between a nested data frame and grouped data frame is that for a grouped data frame, each row is an observation. For a nested data frame each row is a group of observations!

#This will allow us to easily apply function/models across all the data available. 
#Using Tidymodels we can then easily organize the coefficients for our different models!

#the across function allows for selecting specific columns! I want the default time column and I want any column that has the word OD in it in case someone uses multiple ODs for flourescent proteins! 

#THIS WILL ONLY WORK IF YOUR OPTICAL DENSITY CHANNELS HAVE THE WORD OD IN THEM!

PosCtrl %<>%
  select(-c(well, row, column)) %>%
  group_by(across(-c(time, contains("OD")))) %>%
  nest()
  
```

## Fitting Positive Controls

### Fitting 4-HT Positive Controls

```{r Data Modelling and Summary Statistics 4-HT Positive Controls}

source("../Functions/Zwietering_Fitting_Functions.R")

#fitting model and collecting coefficients

 PosCtrl %<>%
  #apply Zwietering model to the data
  mutate(model = map(data, Zwietering.fit)) %>%
  #Create summary of coefficients
  mutate(summary = map(model, tidy)) %>%
  #Get residuals for model that can be plotted on top in a ggplot object
  mutate(augment = map(model, augment)) %>%
  #Using Glance to get an idea of model fit 
  mutate(model.fit = map(model, glance)) 

```

```{r plotting 4-HT controls, fig.height= 6, fig.width= 10}
PosCtrl %>%
  unnest(augment) %>%
  ggplot(aes(x = time, y = OD600)) + 
  geom_point(size = 1.5) + 
  geom_line(aes(y = .fitted), color = "blue", size = 1.25) +
  labs(y = 'Absorbance ('~OD[600]~')', x = "Timepoint (Hr)", title = "4-HT Positive Controls") +
  scale_x_continuous(limits=c(0, 17)) + 
  scale_y_continuous(limits=c(0, 1.8)) +
  facet_wrap(Plate ~ Replicate) +
Theme

```

```{r unnesting for boxplotting of 4-HT controls coefficients}

PosCtrl %<>%
  unnest(summary) %>%
  pivot_wider(names_from = term, values_from = c(estimate, std.error, statistic,p.value))

```

## Investigating Difference in Growth Rate Between Positive Control Conditions

```{r}
#Creating a boxplot to compare the positive controls in different media conditions.
#Do you notice anything...?
ggbetweenstats(
  data = PosCtrl,
  x = Inducer,
  y = estimate_mu
)
```

```{r}
#Seems to be a difference in maximum growth rate! Based on my T-test!
#Therefore I need to proceed with caution and compare cultures to their respective positive controls.
PosCtrl %>%
  infer::t_test(formula = estimate_mu ~ Inducer,
              order = c("DMSO", "4-HT"),
              alternative = "two-sided")
```

## Calculating Starting Parameters for Conditions

```{r}
#I calculated the means for the positive controls by condition. You can use these parameters for the Zwietering_A.fit model if you want to threshold the max OD for your experimental trials!
 
starting_parameters <- PosCtrl %>%
  group_by(Plasmid,Inducer) %>%
  summarize(avg.estimate_A = mean(estimate_A),
            avg.estimate_mu = mean(estimate_mu),
            avg.estimate_lambda = mean(estimate_lambda),)

starting_parameters

HT_param <- starting_parameters %>%
  slice(1) 
 
DMSO_param <- starting_parameters %>%
  slice(2)

```

## Analyzing Variant Model Coefficients

```{r combining growth variant data frames, eval=FALSE, include=FALSE}

#this code chunk could be useful for comparing coefficients between groups! I currently have it not running but you can remove the eval=FALSE to run it!
fitted_growth_variants <- positive_controls %>%
  select(!c(estimate_A, std.error_A, statistic_A, p.value_A)) %>%
  full_join(Growth_4HT_Variants) %>%
  full_join(Growth_DMSO_Variants)

fitted_growth_variants %<>%
  select(!model) %>%
  modify_if(is.character, as.factor) %>%
ungroup() %>%
  mutate(Plasmid = Plasmid %>%
           fct_relevel("+SIR")
         )

rm(positive_controls); rm(Growth_4HT_Variants); rm(Growth_DMSO)
```

